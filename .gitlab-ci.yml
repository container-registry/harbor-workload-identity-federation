stages:
  - build

build-and-push:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  id_tokens:
    ID_TOKEN:
      aud: macfly4200.8gears.ch  # ðŸ‘ˆ audience claim matching your registry
  variables:
    BUILDKIT_HOST: tcp://buildkitd:1234
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Using GitLab OIDC token"

    # Pretty print the JWT token (header and payload)
    - echo "=== JWT Header ==="
    - |
      HEADER=$(echo "$ID_TOKEN" | cut -d'.' -f1 | tr '_-' '/+')
      HEADER_PADDED="${HEADER}$(printf '%*s' $((4 - ${#HEADER} % 4)) '' | tr ' ' '=')"
      echo "$HEADER_PADDED" | base64 -d | jq .
    - echo ""
    - echo "=== JWT Payload ==="
    - |
      PAYLOAD=$(echo "$ID_TOKEN" | cut -d'.' -f2 | tr '_-' '/+')
      PAYLOAD_PADDED="${PAYLOAD}$(printf '%*s' $((4 - ${#PAYLOAD} % 4)) '' | tr ' ' '=')"
      echo "$PAYLOAD_PADDED" | base64 -d | jq .

    # Create Docker config with JWT token for registry auth
    - mkdir -p ~/.docker
    - |
      AUTH=$(echo -n "not-relevant:${ID_TOKEN}" | base64 | tr -d '\n')
      echo "{\"auths\":{\"macfly4200.8gears.ch\":{\"auth\":\"${AUTH}\"}}}" > ~/.docker/config.json

    # Build and push image using remote buildkitd
    - docker buildx create --use --name remote --driver remote ${BUILDKIT_HOST}
    - docker buildx build --push -t macfly4200.8gears.ch/library/image:$CI_COMMIT_SHA .

    # Verify image was pushed by inspecting it
    - docker buildx imagetools inspect macfly4200.8gears.ch/library/image:$CI_COMMIT_SHA
